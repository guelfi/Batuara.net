# Configuração Nginx Multi-Projeto para OCI
# Suporta Batuara.net, MobileMed e outros projetos isoladamente
# Baseado nas práticas do MobileMed

# Rate limiting por projeto
limit_req_zone $binary_remote_addr zone=batuara_api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=batuara_web:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=mobilemed_api:10m rate=15r/s;
limit_req_zone $binary_remote_addr zone=mobilemed_web:10m rate=25r/s;

# Upstream servers - Batuara.net
upstream batuara_public {
    server localhost:3000 max_fails=3 fail_timeout=30s;
}

upstream batuara_admin {
    server localhost:3001 max_fails=3 fail_timeout=30s;
}

upstream batuara_api {
    server localhost:8080 max_fails=3 fail_timeout=30s;
}

# Upstream servers - MobileMed (se necessário)
upstream mobilemed_api {
    server localhost:5000 max_fails=3 fail_timeout=30s;
}

upstream mobilemed_frontend {
    server localhost:5005 max_fails=3 fail_timeout=30s;
}

# Servidor principal - Website Público Batuara.net
server {
    listen 80;
    server_name batuara.net www.batuara.net;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header X-Project "batuara" always;
    
    # Rate limiting
    limit_req zone=batuara_web burst=50 nodelay;
    
    location / {
        proxy_pass http://batuara_public;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Project "batuara";
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Static files caching
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://batuara_public;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Project "batuara";
    }
    
    # Health check específico do Batuara
    location /health {
        access_log off;
        return 200 "batuara-public: healthy\n";
        add_header Content-Type text/plain;
        add_header X-Project "batuara";
    }
}
    
# Dashboard Admin Batuara.net
server {
    listen 80;
    server_name admin.batuara.net;
    
    # Security headers (mais restritivos para admin)
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" always;
    add_header X-Project "batuara-admin" always;
    
    # Rate limiting mais restritivo
    limit_req zone=batuara_web burst=20 nodelay;
    
    location / {
        proxy_pass http://batuara_admin;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Project "batuara-admin";
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Health check específico do admin
    location /health {
        access_log off;
        return 200 "batuara-admin: healthy\n";
        add_header Content-Type text/plain;
        add_header X-Project "batuara-admin";
    }
}
    
# API Backend Batuara.net
server {
    listen 80;
    server_name api.batuara.net;
    
    # Security headers
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header X-Project "batuara-api" always;
    
    # Rate limiting para API
    limit_req zone=batuara_api burst=20 nodelay;
    
    location / {
        proxy_pass http://batuara_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Project "batuara-api";
        
        # CORS headers específicos do Batuara
        add_header Access-Control-Allow-Origin "https://batuara.net https://admin.batuara.net" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,X-Project" always;
        
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "https://batuara.net https://admin.batuara.net";
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,X-Project";
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type "text/plain; charset=utf-8";
            add_header Content-Length 0;
            return 204;
        }
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Health check específico da API
    location /health {
        proxy_pass http://batuara_api/health;
        proxy_set_header X-Project "batuara-api";
        access_log off;
    }
}

# ========================================
# CONFIGURAÇÕES PARA MOBILEMED (se necessário)
# ========================================

# MobileMed API
server {
    listen 80;
    server_name mobilemed-api.local api.mobilemed.local;
    
    # Security headers
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header X-Project "mobilemed-api" always;
    
    # Rate limiting para MobileMed API
    limit_req zone=mobilemed_api burst=25 nodelay;
    
    location / {
        proxy_pass http://mobilemed_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Project "mobilemed-api";
        
        # CORS headers específicos do MobileMed
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,X-Project" always;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Health check MobileMed API
    location /health {
        proxy_pass http://mobilemed_api/health;
        proxy_set_header X-Project "mobilemed-api";
        access_log off;
    }
}

# MobileMed Frontend
server {
    listen 80;
    server_name mobilemed.local www.mobilemed.local;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header X-Project "mobilemed-frontend" always;
    
    # Rate limiting
    limit_req zone=mobilemed_web burst=40 nodelay;
    
    location / {
        proxy_pass http://mobilemed_frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Project "mobilemed-frontend";
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Health check MobileMed Frontend
    location /health {
        access_log off;
        return 200 "mobilemed-frontend: healthy\n";
        add_header Content-Type text/plain;
        add_header X-Project "mobilemed-frontend";
    }
}
    
# ========================================
# CONFIGURAÇÕES GLOBAIS
# ========================================

# Configuração para uploads (se necessário)
client_max_body_size 50M;

# Gzip compression
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/javascript
    application/xml+rss
    application/json;

# Server tokens
server_tokens off;

# Configuração HTTPS (comentada - descomente quando tiver certificado SSL)
# server {
#     listen 443 ssl http2;
#     server_name seu-dominio.com;
#     
#     ssl_certificate /path/to/certificate.crt;
#     ssl_certificate_key /path/to/private.key;
#     
#     # SSL settings
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
#     ssl_prefer_server_ciphers off;
#     
#     # Incluir as mesmas configurações de location do servidor HTTP
#     # ...
# }

# Redirecionamento HTTP para HTTPS (descomente quando tiver SSL)
# server {
#     listen 80;
#     server_name seu-dominio.com;
#     return 301 https://$server_name$request_uri;
# }